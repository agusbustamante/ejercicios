<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liquidaciones de sueldos – ABM</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Encabezado con acciones globales -->
  <header class="barra-superior">
    <div class="barra-inner">
      <h1 class="titulo">Liquidaciones de sueldos</h1>
      <div class="acciones-header">
        <label>Orden:
          <input id="orden" type="text" value="LegajoEmpleado" />
        </label>
        <button id="btnBuscar" class="boton">Cargar datos</button>
        <button id="btnVaciar" class="boton">Vaciar datos</button>
        <button id="btnAlta" class="boton">Alta registro</button>
      </div>
    </div>
  </header>

  <!-- Contenedor principal de la tabla -->
  <main class="tabla-contenedor">
    <div class="tabla-wrapper">
      <table id="tabla" aria-label="Tabla de liquidaciones de sueldos">
        <thead>
          <tr>
            <th data-orden="LegajoEmpleado">Legajo</th>
            <th data-orden="ApellidoYNombres">Apellido y nombres</th>
            <th data-orden="Fecha_liquidacion">Fecha</th>
            <th data-orden="MesDeLiquidacion">Mes</th>
            <th data-orden="SueldoBasico">Sueldo básico</th>
            <th data-orden="concepto_no_remunerativo_1">Concepto no rem. 1</th>
            <th data-orden="Monto_no_remunerativo_1">Monto no rem. 1</th>
            <th>PDF</th>
            <th>Modificar</th>
            <th>Borrar</th>
          </tr>
          <tr class="filtros">
            <th></th><th></th><th></th>
            <th>
              <select id="f_mes" aria-label="Mes de liquidación" title="Mes de liquidación">
                <option value="" selected>(todos)</option>
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
              </select>
            </th>
            <th></th><th></th><th></th><th></th><th></th><th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="10">Sin datos. Pulse “Cargar datos” para consultar.</td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td id="pie" colspan="10">Alumno: <strong>Bustamante Agustin</strong> · Total: 0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </main>

  <footer class="pie">Programación en ambiente de redes – 2025 · Alumno: Bustamante Agustin</footer>

  <!-- Modal: formulario de alta y modificación -->
  <div id="modalForm" class="modal oculto" aria-hidden="true">
    <div class="modal-contenido">
      <h2 id="tituloForm">Registrar liquidación</h2>
      <form id="formLiquidacion" enctype="multipart/form-data">
        <input type="hidden" name="accion" id="accion" value="alta" />
        <input type="hidden" name="legajoOriginal" id="legajoOriginal" />
        <div class="fila-form">
          <label>Legajo:</label>
          <input type="text" name="LegajoEmpleado" id="LegajoEmpleado" required />
        </div>
        <div class="fila-form">
          <label>Apellido y nombres:</label>
          <input type="text" name="ApellidoYNombres" id="ApellidoYNombres" required />
        </div>
        <div class="fila-form">
          <label>Fecha de liquidación:</label>
          <input type="date" name="Fecha_liquidacion" id="Fecha_liquidacion" required />
        </div>
        <div class="fila-form">
          <label>Mes de liquidación:</label>
          <input type="text" name="MesDeLiquidacion" id="MesDeLiquidacion" placeholder="Ej: 2025-10" required />
        </div>
        <div class="fila-form">
          <label>Sueldo básico:</label>
          <input type="number" step="0.01" name="SueldoBasico" id="SueldoBasico" required />
        </div>
        <div class="fila-form">
          <label>Concepto no remunerativo 1:</label>
          <select name="CodConceptoNoRem" id="CodConceptoNoRem" required></select>
        </div>
        <div class="fila-form">
          <label>Monto no remunerativo 1:</label>
          <input type="number" step="0.01" name="Monto_no_remunerativo_1" id="Monto_no_remunerativo_1" required />
        </div>
        <div class="fila-form">
          <label>Documento PDF:</label>
          <input type="file" name="pdf_liquidacion" id="pdf_liquidacion" accept="application/pdf" />
        </div>
        <div class="fila-form acciones-form">
          <button type="submit" id="btnEnviarForm" class="boton">Enviar</button>
          <button type="button" id="btnCancelarForm" class="boton">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: visor de PDF -->
  <div id="modalPDF" class="modal oculto" aria-hidden="true">
    <div class="modal-contenido modal-pdf">
      <iframe id="iframePDF" width="100%" height="600" title="Documento PDF"></iframe>
      <div style="text-align:center;margin-top:.5rem;">
        <button type="button" id="btnCerrarPDF" class="boton">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: respuesta de servidor -->
  <div id="modalRespuesta" class="modal oculto" aria-hidden="true">
    <div class="modal-contenido">
      <h3>Respuesta del servidor</h3>
      <pre id="textoRespuesta" style="white-space:pre-wrap;"></pre>
      <div style="text-align:center;margin-top:.5rem;">
        <button type="button" id="btnCerrarRespuesta" class="boton">Aceptar</button>
      </div>
    </div>
  </div>

<script>
(function(){

  function mostrarModal(id){ const n = document.getElementById(id); n.classList.remove('oculto'); n.setAttribute('aria-hidden','false'); }
  function ocultarModal(id){ const n = document.getElementById(id); n.classList.add('oculto');   n.setAttribute('aria-hidden','true'); }

  /* ===== Params para Ajax ===== */
  function armarParams(){
    const p = new URLSearchParams();
    p.append('orden', document.getElementById('orden').value);
    p.append('f_liquidaciones_mes_num', document.getElementById('f_mes').value);
    return p;
  }

  /* ===== Tabla ===== */
  function renderTabla(list){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    if(!list.length){
      tbody.innerHTML = '<tr><td colspan="10">Sin resultados</td></tr>';
      return;
    }
    const frag = document.createDocumentFragment();
    list.forEach(reg=>{
      const tr = document.createElement('tr');
      tr.dataset.legajo = reg.LegajoEmpleado;

      const cols = [
        reg.LegajoEmpleado,
        reg.ApellidoYNombres,
        reg.Fecha_liquidacion,
        reg.MesDeLiquidacion,
        (Number(reg.SueldoBasico||0)).toFixed(2),
        reg.concepto_no_remunerativo_1 || '',
        (Number(reg.Monto_no_remunerativo_1||0)).toFixed(2)
      ];
      cols.forEach(val=>{ const td=document.createElement('td'); td.textContent = val ?? ''; tr.appendChild(td); });

      // PDF
      const tdPdf = document.createElement('td');
      if (Number(reg.pdf_bytes) > 0) {
        const b = document.createElement('button');
        b.type='button'; b.className='boton-accion'; b.dataset.accion='pdf'; b.textContent='PDF'; b.title='Ver PDF';
        tdPdf.appendChild(b);
      } else { tdPdf.textContent='-'; }
      tr.appendChild(tdPdf);

      // Modi
      const tdM=document.createElement('td'); const bm=document.createElement('button');
      bm.type='button'; bm.className='boton-accion'; bm.dataset.accion='modi'; bm.textContent='Modi'; tdM.appendChild(bm); tr.appendChild(tdM);

      // Borrar
      const tdD=document.createElement('td'); const bd=document.createElement('button');
      bd.type='button'; bd.className='boton-accion'; bd.dataset.accion='borrar'; bd.textContent='Borrar'; tdD.appendChild(bd); tr.appendChild(tdD);

      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }


  async function cargaTabla(){
    const params = armarParams();


    alert(
      'Variables a enviar (antes de Ajax):\n' +
      'orden = ' + params.get('orden') + '\n' +
      'f_liquidaciones_mes_num = ' + (params.get('f_liquidaciones_mes_num')||'(vacío)')
    );

    document.getElementById('tbody').innerHTML = '<tr><td colspan="10">Cargando…</td></tr>';
    try{
      const resp = await fetch('salidaJsonLiquidacionesConPrepare.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: params.toString()
      });
      const json = await resp.json();


      alert('Respuesta listar:\n' + JSON.stringify(json, null, 2));

      renderTabla(json.liquidaciones || []);
      document.getElementById('pie').innerHTML = 'Alumno: <strong>Bustamante Agustin</strong> · Total: ' + (json.cuenta ?? 0);
    }catch(err){
      console.error(err);
      document.getElementById('tbody').innerHTML = '<tr><td colspan="10">Error de comunicación con el servidor.</td></tr>';
    }
  }


  async function cargarConceptos(){
    try{
      const resp = await fetch('salidaJsonConceptos.php');
      const json = await resp.json();

      // Alerta inicial con el JSON recibido
      alert('JSON de familias (datos iniciales):\n' + JSON.stringify(json));

      const sel = document.getElementById('CodConceptoNoRem');
      sel.innerHTML = '';
      (json.conceptos || []).forEach(item=>{
        const opt = document.createElement('option');
        opt.value = item.CodigoConcepto;
        opt.textContent = `${item.CodigoConcepto} – ${item.Descripcion}`;
        sel.appendChild(opt);
      });
    }catch(err){ console.error(err); }
  }

  function abrirAlta(){
    document.getElementById('tituloForm').textContent = 'Alta de liquidación';
    document.getElementById('accion').value = 'alta';
    document.getElementById('legajoOriginal').value = '';
    document.getElementById('formLiquidacion').reset();
    mostrarModal('modalForm');
  }
  function abrirModi(reg){
    document.getElementById('tituloForm').textContent = 'Modificar liquidación';
    document.getElementById('accion').value = 'modi';
    document.getElementById('legajoOriginal').value = reg.LegajoEmpleado;
    document.getElementById('LegajoEmpleado').value = reg.LegajoEmpleado;
    document.getElementById('ApellidoYNombres').value = reg.ApellidoYNombres;
    document.getElementById('Fecha_liquidacion').value = reg.Fecha_liquidacion;
    document.getElementById('MesDeLiquidacion').value = reg.MesDeLiquidacion;
    document.getElementById('SueldoBasico').value = reg.SueldoBasico;
    document.getElementById('CodConceptoNoRem').value = '';
    document.getElementById('Monto_no_remunerativo_1').value = reg.Monto_no_remunerativo_1;
    document.getElementById('pdf_liquidacion').value = '';
    mostrarModal('modalForm');
  }


  async function mostrarPDF(legajo){
    try{
      const r = await fetch('pdf.php?legajo=' + encodeURIComponent(legajo));
      if (!r.ok) { alert('No hay documento PDF registrado'); return; }
      const blob = await r.blob();
      alert('PDF recibido. Tamaño: ' + blob.size + ' bytes');
      const url = URL.createObjectURL(blob);
      const iframe = document.getElementById('iframePDF');
      if (iframe) { iframe.src = url; mostrarModal('modalPDF'); } else { window.open(url, '_blank'); }
    }catch(err){ console.error(err); alert('Error al obtener el PDF.'); }
  }

  async function enviarFormulario(ev){
    ev.preventDefault();
    const form = ev.target;
    const accion = document.getElementById('accion').value;
    const url = (accion === 'alta') ? 'alta.php' : 'modi.php';
    const fd = new FormData(form);

    const leg = document.getElementById('LegajoEmpleado').value;
    if (accion === 'modi') {
      if (!confirm('¿Estás seguro que desea modificar el registro ' + leg + '?')) return;
      fd.append('LegajoEmpleadoOriginal', document.getElementById('legajoOriginal').value);
    } else {
      if (!confirm('¿Estás seguro de insertar el registro? ' + leg)) return;
    }

    try{
      const resp = await fetch(url, { method: 'POST', body: fd });
      const json = await resp.json();

      alert('Respuesta del servidor:\n' + (json.estado || JSON.stringify(json)));

      document.getElementById('textoRespuesta').textContent = json.estado || JSON.stringify(json);
      ocultarModal('modalForm'); mostrarModal('modalRespuesta');
      cargaTabla();
    }catch(err){
      console.error(err);
      document.getElementById('textoRespuesta').textContent = 'Error de comunicación con el servidor.';
      ocultarModal('modalForm'); mostrarModal('modalRespuesta');
    }
  }


  async function eliminarRegistro(legajo){
    if(!confirm('¿Estás seguro que desea borrar eliminar el ' + legajo + '?')) return;
    try{
      const params = new URLSearchParams(); params.append('LegajoEmpleado', legajo);
      const resp = await fetch('baja.php', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params.toString() });
      const json = await resp.json();

      alert('Respuesta de la baja:\n' + (json.estado || JSON.stringify(json)));

      document.getElementById('textoRespuesta').textContent = json.estado || JSON.stringify(json);
      mostrarModal('modalRespuesta'); cargaTabla();
    }catch(err){ console.error(err); alert('Error al eliminar.'); }
  }

  /* ===== Delegaciones y botones ===== */
  document.getElementById('tbody').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const acc = btn.dataset.accion; const tr = btn.closest('tr'); const legajo = tr.dataset.legajo;
    if(acc==='pdf'){ mostrarPDF(legajo);
    }else if(acc==='modi'){
      const c = tr.querySelectorAll('td');
      const reg = { LegajoEmpleado:c[0].textContent, ApellidoYNombres:c[1].textContent, Fecha_liquidacion:c[2].textContent, MesDeLiquidacion:c[3].textContent, SueldoBasico:c[4].textContent, Monto_no_remunerativo_1:c[6].textContent };
      abrirModi(reg);
    }else if(acc==='borrar'){ eliminarRegistro(legajo); }
  });

  document.querySelector('#tabla thead').addEventListener('click', (ev)=>{
    const th = ev.target.closest('[data-orden]'); if(!th) return;
    document.getElementById('orden').value = th.dataset.orden;
  });

  document.getElementById('btnBuscar').addEventListener('click', cargaTabla);
  document.getElementById('btnVaciar').addEventListener('click', ()=>{
    document.getElementById('tbody').innerHTML = '<tr><td colspan="10">Sin datos</td></tr>';
    document.getElementById('pie').innerHTML = 'Alumno: <strong>Bustamante Agustin</strong> · Total: 0';
  });
  document.getElementById('btnAlta').addEventListener('click', abrirAlta);

  document.getElementById('btnCancelarForm').addEventListener('click', ()=> ocultarModal('modalForm'));
  document.getElementById('btnCerrarPDF').addEventListener('click', ()=>{ document.getElementById('iframePDF').src=''; ocultarModal('modalPDF'); });
  document.getElementById('btnCerrarRespuesta').addEventListener('click', ()=> ocultarModal('modalRespuesta'));
  document.getElementById('formLiquidacion').addEventListener('submit', enviarFormulario);

  cargarConceptos();
})();
</script>

</body>
</html>
